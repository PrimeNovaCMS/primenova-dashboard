<script>
  // ðŸ”— Put your published Dashboard CSV link here
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRr9k9ClkLjP2X6qaZxsjEWVgBAWWKFS5g5gFmwtN9-nP-NUEYMtWhRiu7Qm4uyweot1-GQm43JYqy0/pub?gid=1139815476&single=true&output=csv";

  function formatNaira(value) {
    const n = Number((value || "0").replace(/[^0-9.\-]/g, ""));
    return "â‚¦" + n.toLocaleString("en-NG", { maximumFractionDigits: 2 });
  }

  // Robust CSV line parser that handles commas inside quoted fields
  function parseCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        // Toggle inQuotes, but ignore escaped quotes ("")
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++; // skip escaped quote
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === "," && !inQuotes) {
        result.push(current);
        current = "";
      } else {
        current += char;
      }
    }
    result.push(current);
    return result;
  }

  async function fetchDashboardRows() {
    const res = await fetch(CSV_URL);
    const text = await res.text();

    const lines = text.trim().split(/\r?\n/);
    if (lines.length <= 1) return [];

    // Header row
    const headerCols = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());

    function colIndex(name) {
      return headerCols.indexOf(name.toLowerCase());
    }

    const idxMemberId          = colIndex("member_id");
    const idxFullName          = colIndex("full_name");
    const idxCategory          = colIndex("membership_category");
    const idxSavings           = colIndex("total_savings");
    const idxShareCapital      = colIndex("total_share_capital");
    const idxLoanBalance       = colIndex("loan_balance");
    const idxLoanEligStatus    = colIndex("loan_eligibility_status");
    const idxLoanAppStatus     = colIndex("loan_application_status");
    const idxLoanAmountElig    = colIndex("loan_amount_eligible");
    const idxRepayDefaultDays  = colIndex("repayment_default_days");
    const idxPassword          = colIndex("password");
    const idxLastUpdated       = colIndex("last_updated");

    const dataLines = lines.slice(1);

    return dataLines.map(line => {
      const cols = parseCSVLine(line);
      function get(i) {
        return (i >= 0 && i < cols.length ? cols[i] : "").trim();
      }
      return {
        member_id:              get(idxMemberId),
        full_name:              get(idxFullName),
        membership_category:    get(idxCategory),
        total_savings:          get(idxSavings),
        total_share_capital:    get(idxShareCapital),
        loan_balance:           get(idxLoanBalance),
        loan_eligibility_status:get(idxLoanEligStatus),
        loan_application_status:get(idxLoanAppStatus),
        loan_amount_eligible:   get(idxLoanAmountElig),
        repayment_default_days: get(idxRepayDefaultDays),
        password:               get(idxPassword),
        last_updated:           get(idxLastUpdated)
      };
    });
  }

  async function handleView(event) {
    if (event && event.preventDefault) event.preventDefault();

    const memberInput = document.getElementById("memberId");
    const passInput   = document.getElementById("password");
    const errorEl     = document.getElementById("error");
    const result      = document.getElementById("result");
    const viewBtn     = document.getElementById("viewBtn");

    errorEl.textContent = "";
    result.style.display = "none";

    const memberId = (memberInput.value || "").trim();
    const password = (passInput.value   || "").trim();

    if (!memberId || !password) {
      errorEl.textContent = "Please enter both Membership ID and Password.";
      return;
    }

    viewBtn.disabled = true;
    viewBtn.textContent = "Loading...";

    try {
      const rows = await fetchDashboardRows();

      const idNorm   = memberId.toLowerCase();
      const passNorm = password; // password is case-sensitive

      const match = rows.find(r =>
        (r.member_id || "").toLowerCase() === idNorm &&
        (r.password  || "") === passNorm
      );

      if (!match) {
        errorEl.textContent = "Invalid Membership ID or Password.";
        return;
      }

      // Fill profile info
      document.getElementById("name").textContent       = match.full_name || "";
      document.getElementById("category").textContent   = match.membership_category || "";
      document.getElementById("idDisplay").textContent  = match.member_id || "";

      // Money fields
      document.getElementById("savings").textContent       = formatNaira(match.total_savings);
      document.getElementById("shareCapital").textContent  = formatNaira(match.total_share_capital);
      document.getElementById("loanBalance").textContent   = formatNaira(match.loan_balance);
      document.getElementById("loanEligible").textContent  = formatNaira(match.loan_amount_eligible);

      // Status fields
      document.getElementById("loanEligibilityStatus").textContent =
        match.loan_eligibility_status || "N/A";

      document.getElementById("loanApplicationStatus").textContent =
        match.loan_application_status || "N/A";

      // Default days
      const defaultDaysRaw =
        (match.repayment_default_days || "").replace(/[^0-9.\-]/g, "");
      const defaultDays = Number(defaultDaysRaw || "0");
      document.getElementById("repaymentDefaultDays").textContent = defaultDays;

      // Last updated
      document.getElementById("lastUpdated").textContent =
        match.last_updated || "Contact Secretariat";

      result.style.display = "block";
    } catch (e) {
      console.error(e);
      errorEl.textContent = "Error loading data. Please try again later.";
    } finally {
      viewBtn.disabled = false;
      viewBtn.textContent = "View My Summary";
    }
  }

  function handleLogout() {
    const memberInput = document.getElementById("memberId");
    const passInput   = document.getElementById("password");
    const result      = document.getElementById("result");
    const errorEl     = document.getElementById("error");

    memberInput.value = "";
    passInput.value   = "";
    result.style.display = "none";
    errorEl.textContent = "";
    memberInput.focus();
  }

  // Ensure elements exist before binding
  window.addEventListener("DOMContentLoaded", () => {
    const viewBtn   = document.getElementById("viewBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    if (viewBtn)   viewBtn.addEventListener("click", handleView);
    if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
  });
</script>
