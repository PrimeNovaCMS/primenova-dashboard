<script>
  // ðŸ”— Put your published Dashboard CSV link here
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRr9k9ClkLjP2X6qaZxsjEWVgBAWWKFS5g5gFmwtN9-nP-NUEYMtWhRiu7Qm4uyweot1-GQm43JYqy0/pubhtml?gid=1139815476&single=true";

  function formatNaira(value) {
    const n = Number((value || "0").replace(/[^0-9.\-]/g, ""));
    return "â‚¦" + n.toLocaleString("en-NG", { maximumFractionDigits: 2 });
  }

  // âœ… Robust CSV parser that handles commas inside quoted values
  function parseCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === "," && !inQuotes) {
        result.push(current);
        current = "";
      } else {
        current += char;
      }
    }

    result.push(current);
    return result;
  }

  async function fetchDashboardRows() {
    const res = await fetch(CSV_URL);
    const text = await res.text();

    const lines = text.trim().split("\n");
    if (lines.length <= 1) return [];

    const dataLines = lines.slice(1); // skip header

    // âœ… Expected column order:
    // 0: member_id
    // 1: full_name
    // 2: membership_category
    // 3: total_savings
    // 4: total_share_capital
    // 5: loan_balance
    // 6: loan_eligibility_status
    // 7: loan_application_status
    // 8: loan_amount_eligible
    // 9: repayment_default_days
    // 10: password
    // 11: last_updated
    return dataLines.map(line => {
      const cols = parseCSVLine(line);
      return {
        member_id: (cols[0] || "").trim(),
        full_name: (cols[1] || "").trim(),
        membership_category: (cols[2] || "").trim(),
        total_savings: (cols[3] || "").trim(),
        total_share_capital: (cols[4] || "").trim(),
        loan_balance: (cols[5] || "").trim(),
        loan_eligibility_status: (cols[6] || "").trim(),
        loan_application_status: (cols[7] || "").trim(),
        loan_amount_eligible: (cols[8] || "").trim(),
        repayment_default_days: (cols[9] || "").trim(),
        password: (cols[10] || "").trim(),
        last_updated: (cols[11] || "").trim()
      };
    });
  }

  async function handleView() {
    const memberInput = document.getElementById("memberId");
    const passInput = document.getElementById("password");
    const errorEl = document.getElementById("error");
    const result = document.getElementById("result");
    const viewBtn = document.getElementById("viewBtn");

    errorEl.textContent = "";
    result.style.display = "none";

    const memberId = (memberInput.value || "").trim();
    const password = (passInput.value || "").trim();

    if (!memberId || !password) {
      errorEl.textContent = "Please enter both Membership ID and Password.";
      return;
    }

    viewBtn.disabled = true;
    viewBtn.textContent = "Loading...";

    try {
      const rows = await fetchDashboardRows();

      const idNorm = memberId.toLowerCase();
      const passNorm = password; // password is case-sensitive

      const match = rows.find(r =>
        r.member_id.toLowerCase() === idNorm &&
        r.password === passNorm
      );

      if (!match) {
        errorEl.textContent = "Invalid Membership ID or Password.";
        return;
      }

      // âœ… Basic Info
      document.getElementById("name").textContent = match.full_name || "";
      document.getElementById("category").textContent = match.membership_category || "";
      document.getElementById("idDisplay").textContent = match.member_id || "";

      // âœ… Financials
      document.getElementById("savings").textContent = formatNaira(match.total_savings);
      document.getElementById("shareCapital").textContent = formatNaira(match.total_share_capital);
      document.getElementById("loanBalance").textContent = formatNaira(match.loan_balance);
      document.getElementById("loanEligible").textContent = formatNaira(match.loan_amount_eligible);

      // âœ… Loan Status
      document.getElementById("loanEligibilityStatus").textContent =
        match.loan_eligibility_status || "N/A";

      document.getElementById("loanApplicationStatus").textContent =
        match.loan_application_status || "N/A";

      // âœ… Repayment Default
      const defaultDaysRaw =
        (match.repayment_default_days || "").replace(/[^0-9.\-]/g, "");
      const defaultDays = Number(defaultDaysRaw || "0");
      document.getElementById("repaymentDefaultDays").textContent = defaultDays;

      // âœ… Last Updated
      document.getElementById("lastUpdated").textContent =
        match.last_updated || "Contact Secretariat";

      result.style.display = "block";
    } catch (e) {
      console.error(e);
      errorEl.textContent = "Error loading data. Please try again later.";
    } finally {
      viewBtn.disabled = false;
      viewBtn.textContent = "View My Summary";
    }
  }

  function handleLogout() {
    const memberInput = document.getElementById("memberId");
    const passInput = document.getElementById("password");
    const result = document.getElementById("result");
    const errorEl = document.getElementById("error");

    memberInput.value = "";
    passInput.value = "";
    result.style.display = "none";
    errorEl.textContent = "";
    memberInput.focus();
  }

  document.getElementById("viewBtn").addEventListener("click", handleView);
  document.getElementById("logoutBtn").addEventListener("click", handleLogout);
</script>
